name: Generate Image

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt para gerar a imagem'
        required: true
        default: 'uma paisagem futurista'
      negative_prompt:
        description: 'Prompt negativo (opcional)'
        required: false
        default: ''
      steps:
        description: 'Número de passos de inferência (máx 25)'
        required: false
        default: '15'
      guidance:
        description: 'Escala de orientação'
        required: false
        default: '7.5'
      width:
        description: 'Largura da imagem (máx 512)'
        required: false
        default: '256'
      height:
        description: 'Altura da imagem (máx 512)'
        required: false
        default: '256'
      seed:
        description: 'Seed para reprodutibilidade (opcional)'
        required: false
        default: ''
      batch:
        description: 'Número de imagens para gerar'
        required: false
        default: '1'

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Cache de dependências
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}-v2
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache do modelo
      uses: actions/cache@v4
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-huggingface-models-v2
        restore-keys: |
          ${{ runner.os }}-huggingface-models-
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verificar instalação
      run: |
        python -c "import torch; print(f'PyTorch: {torch.__version__}')"
        python -c "import diffusers; print(f'Diffusers: {diffusers.__version__}')"
    
    - name: Gerar imagem
      run: |
        python action_runner.py \
          --prompt "${{ github.event.inputs.prompt }}" \
          --negative-prompt "${{ github.event.inputs.negative_prompt }}" \
          --steps ${{ github.event.inputs.steps }} \
          --guidance ${{ github.event.inputs.guidance }} \
          --width ${{ github.event.inputs.width }} \
          --height ${{ github.event.inputs.height }} \
          --seed "${{ github.event.inputs.seed }}" \
          --batch ${{ github.event.inputs.batch }}
    
    - name: Upload imagens geradas
      uses: actions/upload-artifact@v4
      with:
        name: generated-images-${{ github.run_number }}
        path: generated_images/*.png
        retention-days: 30
    
    - name: Commit imagens ao repositório
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add generated_images/*.png || echo "Nenhuma imagem para adicionar"
        git diff --staged --quiet || git commit -m "Add generated images from workflow run #${{ github.run_number }}"
        git push || echo "Nada para fazer push"
